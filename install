#!/bin/zsh

export USERNAME=`whoami`

# GitHub Codespaces specific - add waiter to shell profiles early
if [ -n "${CODESPACES}" ]; then
  # Copy waiter script to a location available before stow
  # TODO: COPYING HERE BREAKS STOW LATER
  # mkdir -p ~/.local/bin
  # cp "$(dirname "$0")/bin/.local/bin/waiter" ~/.local/bin/waiter
  # chmod +x ~/.local/bin/waiter

  # Add waiter to .bashrc if it exists (default shell in codespaces)
  if [ -f ~/.bashrc ]; then
    # Only add if not already present and if dotfiles not complete
    if ! grep -q "Auto-launch waiter for dotfiles setup" ~/.bashrc; then
      echo '' >> ~/.bashrc
      echo '# Auto-launch waiter for dotfiles setup (added by dotfiles install)' >> ~/.bashrc
      echo 'if [ ! -f "$HOME/.dotfiles_complete" ] && [ -f "$HOME/.local/bin/waiter" ]; then' >> ~/.bashrc
      echo '  exec $HOME/.local/bin/waiter' >> ~/.bashrc
      echo 'fi' >> ~/.bashrc
    fi
  fi
fi

sudo chsh -s $(which zsh) $USERNAME

mkdir -p ~/bin

# DEBIAN specific
if [ -f "/etc/debian_version" ]; then
  sudo apt update
  sudo apt install -y \
    stow \
    tmux \
    fzf \
    ripgrep \
    kitty-terminfo

  # if brew isn't installed install it
  if ! command -v brew &> /dev/null; then
    echo "Homebrew not found, installing..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
  fi

  brew install jj zellij neovim

  wget https://github.com/BlakeWilliams/remote-development-manager/releases/latest/download/rdm-linux-amd64
  if [ ! -f "rdm-linux-amd64" ]; then wget https://github.com/BlakeWilliams/remote-development-manager/releases/download/v0.0.6/rdm-linux-amd64; fi
  mv rdm-linux-amd64 ~/bin/rdm
  chmod +x ~/bin/rdm
fi

# GitHub Codespaces specific
if [ -n "${CODESPACES}" ]; then
  # Install bat
  sudo apt install bat -y
  mkdir -p ~/.local/bin
  ln -s /usr/bin/batcat ~/.local/bin/bat
fi

## Install starship
curl -sS https://starship.rs/install.sh | sh -s -- --yes

## Install prezto
# if prezto folder does not exist then clone it
if [ ! -d ~/.zprezto ]; then
  git clone --recursive https://github.com/sorin-ionescu/prezto.git "${ZDOTDIR:-$HOME}/.zprezto"
fi

rm -f ~/.gitconfig # remove any default .zshrc so that stow won't fail

# if ~/.zshrc already exists then append its contents to zsh/.zshrc
if [ -f ~/.zshrc ]; then
  # echo "" >> zsh/.zshrc
  # echo "# Appended from pre-existing ~/.zshrc" >> zsh/.zshrc
  # cat ~/.zshrc >> zsh/.zshrc
  rm -f ~/.zshrc
fi

# if ~/.zprofile already exists then append its contents to zsh/.zprofile
if [ -f ~/.zprofile ]; then
  echo "" >> zsh/.zprofile
  echo "# Appended from pre-existing ~/.zprofile" >> zsh/.zprofile
  cat ~/.zprofile >> zsh/.zprofile
  rm -f ~/.zprofile
fi

stow bin git terminal tmux vim zsh jj opencode -t $HOME

## Install OpenCode
curl -fsSL https://opencode.ai/install | bash

## Install and configure oh-my-opencode plugin
bunx oh-my-opencode install --no-tui --claude=no --openai=no --gemini=no --copilot=yes

## NEOVIM setup
nvim --headless "+Lazy! sync" +qa

## Download Alacritty terminfo
curl -sSL https://raw.githubusercontent.com/alacritty/alacritty/master/extra/alacritty.info | tic -x -

## Mark dotfiles installation as complete
touch ~/.dotfiles_complete
